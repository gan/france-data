# Task 7: Master Scheduler Function 实现

## 任务基本信息
- **任务ID**: 7
- **标题**: Implement Master Scheduler Function
- **优先级**: 高
- **依赖任务**: Task 3, 4, 5, 6 (所有数据收集器)
- **预估工时**: 30-45分钟
- **负责人**: Claude Code Assistant

## 任务目标
创建主调度器函数，用于异步触发所有数据收集器（DVF、SIRENE、INSEE、PLU），实现故障隔离、状态跟踪和灵活的配置管理。

## 详细需求

### 1. 核心功能要求
- **异步调度**: 使用Cloud Tasks或HTTP调用异步触发各个收集器
- **故障隔离**: 单个收集器失败不影响其他收集器执行
- **状态跟踪**: 记录每个收集器的执行状态和结果
- **配置管理**: 支持启用/禁用特定收集器
- **执行报告**: 生成整体执行摘要和统计信息

### 2. 技术规格
- **触发方式**: Cloud Scheduler定时触发
- **调用机制**: Cloud Tasks队列或直接HTTP调用
- **错误处理**: 重试机制和失败通知
- **监控集成**: 与Cloud Monitoring集成

### 3. 实现细节
- **文件路径**: `/scheduler/master_scheduler.py`
- **入口函数**: `master_scheduler_main()`
- **配置文件**: 使用现有`config.yaml`
- **日志规范**: 结构化JSON日志

## 子任务分解

### 7.1 创建主调度器核心结构
- [ ] 创建master_scheduler.py文件
- [ ] 实现基础类和初始化逻辑
- [ ] 集成配置管理系统

### 7.2 实现异步调用机制
- [ ] 实现Cloud Tasks客户端集成
- [ ] 实现HTTP调用备选方案
- [ ] 添加调用超时和重试逻辑

### 7.3 实现故障隔离逻辑
- [ ] 独立的错误处理包装器
- [ ] 失败收集器的状态记录
- [ ] 部分成功的结果聚合

### 7.4 状态跟踪和报告
- [ ] 实现执行状态数据结构
- [ ] 收集各收集器的执行结果
- [ ] 生成综合执行报告

### 7.5 配置和控制功能
- [ ] 读取收集器启用/禁用配置
- [ ] 实现动态收集器列表管理
- [ ] 支持调度参数配置

### 7.6 测试和验证
- [ ] 编写单元测试
- [ ] 模拟Cloud Tasks调用
- [ ] 测试故障隔离机制
- [ ] 验证配置管理功能

## 验收标准
- [ ] 主调度器能成功触发所有启用的收集器
- [ ] 单个收集器失败不影响其他收集器执行
- [ ] 正确记录所有收集器的执行状态
- [ ] 生成包含时间戳、状态、错误信息的执行报告
- [ ] 支持通过配置启用/禁用特定收集器
- [ ] 完整的单元测试覆盖
- [ ] Cloud Function兼容部署

## 技术架构

```python
# 预期的调度器架构
class MasterScheduler:
    def __init__(self):
        # 初始化配置和客户端
        
    def schedule_collectors(self):
        # 主调度逻辑
        
    def trigger_collector_async(self, collector_name):
        # 异步触发单个收集器
        
    def track_execution_status(self):
        # 跟踪执行状态
        
    def generate_execution_report(self):
        # 生成执行报告
```

## 风险和挑战
1. **并发控制**: 需要处理多个异步任务的并发执行
2. **错误传播**: 确保错误信息正确传递但不影响其他任务
3. **超时管理**: 处理长时间运行的收集器
4. **资源限制**: Cloud Functions的执行时间限制

## 期望成果
- 健壮的主调度器实现
- 完整的错误处理和故障隔离
- 灵活的配置管理系统
- 详细的执行报告和监控集成

---
*任务定义创建时间: 2025-06-26*
*创建者: Claude Code Assistant*